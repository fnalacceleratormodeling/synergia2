#!/bin/sh

usage() {
    echo "usage: $0 [synergia_arguments] <synergia_script> [script_arguments]"
    echo "synergia_arguments:"
    echo "         -i         : enter interactive Python mode"
    echo "         --ipython  : enter IPython interactive mode (if available)"
    echo "         --help     : this message"
}

if [ -z "$1" ]; then
    usage
    exit 1
fi
if [ "$1" = "--help" ]; then
    usage
    exit 0
fi

tmp_bin_dir="`dirname \"$0\"`"
install_dir="`dirname \"$tmp_bin_dir\"`"

SYNERGIA2DIR="$install_dir/lib"
export SYNERGIA2DIR

pathadd ()
{
    PATH="$1:$PATH"
    export PATH
}

ldpathadd ()
{
    if [ "`uname`" = "Darwin" ]; then
        if [ -z "$DYLD_LIBRARY_PATH" ]; then
            DYLD_LIBRARY_PATH="$1"
        else
            DYLD_LIBRARY_PATH="$1:$DYLD_LIBRARY_PATH"
        fi
        export DYLD_LIBRARY_PATH
    else
        if [ -z "$LD_LIBRARY_PATH" ]; then
            LD_LIBRARY_PATH="$1"
        else
            LD_LIBRARY_PATH="$1:$LD_LIBRARY_PATH"
        fi
        export LD_LIBRARY_PATH
    fi
}

pythonpathadd ()
{
    if [ -z "$PYTHONPATH" ]; then
        PYTHONPATH="$1"
    else
        PYTHONPATH="$1:$PYTHONPATH"
    fi
    export PYTHONPATH
}

pathadd "$install_dir/bin"
ldpathadd "$install_dir/lib"

install_site_packages="`/bin/ls -d \"$install_dir\"/lib*/*/site-packages 2>/dev/null`"
chef_lib_dirs=`chef-config.sh --lib_dirs_list | sed 's/;/ /g'`
for dir in $install_site_packages $chef_lib_dirs
do
    pythonpathadd $dir
done

if [ x"$1" = x"--path" ]; then
    echo "$PATH"
    exit 0
fi

if [ x"$1" = x"--ldlibrarypath" ]; then
    if [ "`uname`" = "Darwin" ]; then
        echo "$DYLD_LIBRARY_PATH"
    else
        echo "$LD_LIBRARY_PATH"
    fi
    exit 0
fi

if [ x"$1" = x"--pythonpath" ]; then
	echo "$PYTHONPATH"
	exit 0
fi

PYTHON_EXECUTABLE="${PYTHON_EXECUTABLE}"
if [ x"$1" = x"--ipython" ]; then
	PYTHON_EXECUTABLE=ipython
	shift
fi

if [ x"$1" = x"-c" ]; then
	exec "$PYTHON_EXECUTABLE" "$@"
fi

just_options=false
options_file="`basename \"$1\" .py 2> /dev/null`_options.py"
if [ -f "$options_file" ]; then
	for arg in "$@"
	do
		if [ x"$arg" = x"--help" ]; then
			just_options=true
		fi
		if [ x"$arg" = x"createjob=1" ]; then
			just_options=true
		fi
		if [ x"$arg" = x"createjob=true" ]; then
			just_options=true
		fi
		if [ x"$arg" = x"createjob=t" ]; then
			just_options=true
		fi
	done
fi

if [ "$just_options" = "true" ]; then
	exec "$PYTHON_EXECUTABLE" "$options_file" --strip-options-file "$@"
else
	exec "$PYTHON_EXECUTABLE" "$@"
fi
